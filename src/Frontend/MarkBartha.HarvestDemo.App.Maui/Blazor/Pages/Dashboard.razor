@page "/"
@attribute [Authorize]
@using System.Threading
@implements IAsyncDisposable
@inject TodoState TodoState

<PageTitle>Tasks</PageTitle>

@{
    var todos = TodoState.Items;
    var isLoading = TodoState.IsLoading;
}

<main class="content-container page-padding pb-32 md:pb-6 flex-1">
    <div class="max-w-5xl mx-auto w-full space-y-6">

        <section class="hidden md:block">
            <AddTodoInput IsInline="true"
                          Value="@newTodoText"
                          ValueChanged="HandleDesktopValueChanged"
                          OnSubmit="AddTodoFromDesktopAsync"
                          OnKeyDown="HandleDesktopKeyDownAsync"
                          @ref="desktopAddRef"/>
        </section>

        <section class="md:hidden @(isAddingMobile ? string.Empty : "hidden")">
            <AddTodoInput IsInline="false"
                          Value="@newTodoMobileText"
                          ValueChanged="HandleMobileValueChanged"
                          OnSubmit="AddTodoFromMobileAsync"
                          OnCancel="CancelMobileAdd"
                          OnKeyDown="HandleMobileKeyDownAsync"
                          @ref="mobileAddRef"/>
        </section>

        @if (isLoading)
        {
            <div class="flex justify-center py-12 text-sm text-[color:var(--color-text-muted)]">
                Loading tasks...
            </div>
        }

        <TodoList Items="todos" Toggle="ToggleTodoAsync" Delete="DeleteTodoAsync"/>

        <section class="text-center py-12 @((!isLoading && todos.Count == 0) ? string.Empty : "hidden")" data-state="empty">
            <div class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center bg-brand text-white">
                <i class="icon-check text-xl" aria-hidden="true"></i>
            </div>
            <p class="text-[color:var(--color-text-muted)] text-lg">No tasks yet</p>
        </section>
    </div>
</main>

<FloatingActionButton Hidden="@isAddingMobile" OnClick="StartMobileAddAsync" />

@code {
    private CancellationTokenSource? _cts;
    private string newTodoText = string.Empty;
    private string newTodoMobileText = string.Empty;
    private bool isAddingMobile;

    private AddTodoInput? desktopAddRef;
    private AddTodoInput? mobileAddRef;

    protected override async Task OnInitializedAsync()
    {
        _cts = new CancellationTokenSource();
        TodoState.StateChanged += HandleTodoStateChanged;

        await UserProfileState.EnsureLoadedAsync(_cts.Token);
        await TodoState.InitializeAsync(_cts.Token);
    }

    private void HandleTodoStateChanged() => InvokeAsync(StateHasChanged);

    private void HandleDesktopValueChanged(string? value) => newTodoText = value ?? string.Empty;
    private void HandleMobileValueChanged(string? value) => newTodoMobileText = value ?? string.Empty;

    private async Task AddTodoFromDesktopAsync()
    {
        if (await TryAddTodoAsync(newTodoText))
        {
            newTodoText = string.Empty;
        }
    }

    private async Task AddTodoFromMobileAsync()
    {
        if (await TryAddTodoAsync(newTodoMobileText))
        {
            newTodoMobileText = string.Empty;
            isAddingMobile = false;
        }
    }

    private async Task<bool> TryAddTodoAsync(string? value)
    {
        var trimmed = value?.Trim();
        if (string.IsNullOrWhiteSpace(trimmed))
        {
            return false;
        }

        var token = _cts?.Token ?? CancellationToken.None;
        await TodoState.AddAsync(trimmed, token);
        return true;
    }

    private Task ToggleTodoAsync(string id)
    {
        var token = _cts?.Token ?? CancellationToken.None;
        return TodoState.ToggleAsync(id, token);
    }

    private Task DeleteTodoAsync(string id)
    {
        var token = _cts?.Token ?? CancellationToken.None;
        return TodoState.DeleteAsync(id, token);
    }

    private async Task StartMobileAddAsync()
    {
        isAddingMobile = true;
        newTodoMobileText = string.Empty;

        await Task.Yield();
        if (mobileAddRef is not null)
        {
            await mobileAddRef.FocusAsync();
        }
    }

    private void CancelMobileAdd()
    {
        newTodoMobileText = string.Empty;
        isAddingMobile = false;
    }

    private async Task HandleDesktopKeyDownAsync(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await AddTodoFromDesktopAsync();
        }
    }

    private async Task HandleMobileKeyDownAsync(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await AddTodoFromMobileAsync();
        }
    }

    public ValueTask DisposeAsync()
    {
        TodoState.StateChanged -= HandleTodoStateChanged;
        if (_cts is not null)
        {
            _cts.Cancel();
            _cts.Dispose();
        }

        return ValueTask.CompletedTask;
    }
}
