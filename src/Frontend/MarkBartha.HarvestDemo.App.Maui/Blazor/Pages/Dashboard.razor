@page "/"
@attribute [Authorize]
@using System.Threading
@implements IAsyncDisposable
@inject TodoState TodoState

<PageTitle>Tasks</PageTitle>

@{
    var todos = TodoState.Items;
    var isLoading = TodoState.IsLoading;
    var isEmptyState = !isLoading && todos.Count == 0;
}

<main class="content-container page-padding pb-32 md:pb-6 flex-1">
    <div class="max-w-5xl mx-auto w-full space-y-6">

        <section class="hidden md:block">
            <AddTodo IsInline="true"
                          Value="@GetInput(AddTodoContext.Desktop)"
                          ValueChanged="value => HandleValueChanged(AddTodoContext.Desktop, value)"
                          OnSubmit="() => AddTodoAsync(AddTodoContext.Desktop)"
                          OnKeyDown="args => HandleKeyDownAsync(AddTodoContext.Desktop, args)"
                          @ref="desktopAddRef"/>
        </section>

        <section class="md:hidden @(isAddingMobile ? string.Empty : "hidden")">
            <AddTodo IsInline="false"
                          Value="@GetInput(AddTodoContext.Mobile)"
                          ValueChanged="value => HandleValueChanged(AddTodoContext.Mobile, value)"
                          OnSubmit="() => AddTodoAsync(AddTodoContext.Mobile)"
                          OnCancel="CancelMobileAdd"
                          OnKeyDown="args => HandleKeyDownAsync(AddTodoContext.Mobile, args)"
                          @ref="mobileAddRef"/>
        </section>

        @if (isLoading)
        {
            <div class="flex justify-center py-12 text-sm text-[color:var(--color-text-muted)]">
                Loading tasks...
            </div>
        }

        <TodoList Items="todos" Toggle="ToggleTodoAsync" Delete="DeleteTodoAsync"/>

        <section class="text-center py-12 @(isEmptyState ? string.Empty : "hidden")" data-state="empty">
            <div class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center bg-brand text-white">
                <i class="icon-check text-xl" aria-hidden="true"></i>
            </div>
            <p class="text-[color:var(--color-text-muted)] text-lg">No tasks yet</p>
        </section>
    </div>
</main>

<FloatingActionButton Hidden="@isAddingMobile" OnClick="StartMobileAddAsync" />

@code {
    private CancellationTokenSource _cts;
    private string newTodoText = string.Empty;
    private string newTodoMobileText = string.Empty;
    private bool isAddingMobile;

    private AddTodo desktopAddRef = null;
    private AddTodo mobileAddRef = null;

    protected override async Task OnInitializedAsync()
    {
        TodoState.StateChanged += HandleTodoStateChanged;

        _cts = new CancellationTokenSource();
        await UserProfileState.EnsureLoadedAsync(_cts.Token);
        await TodoState.InitializeAsync(_cts.Token);
    }

    private void HandleTodoStateChanged() => InvokeAsync(StateHasChanged);

    private enum AddTodoContext
    {
        Desktop,
        Mobile,
    }

    private string GetInput(AddTodoContext context) =>
        context switch
        {
            AddTodoContext.Desktop => newTodoText,
            AddTodoContext.Mobile => newTodoMobileText,
            _ => throw new ArgumentOutOfRangeException(nameof(context), context, null),
        };

    private void SetInput(AddTodoContext context, string value)
    {
        switch (context)
        {
            case AddTodoContext.Desktop:
                newTodoText = value;
                break;
            case AddTodoContext.Mobile:
                newTodoMobileText = value;
                break;
            default:
                throw new ArgumentOutOfRangeException(nameof(context), context, null);
        }
    }

    private void HandleValueChanged(AddTodoContext context, string value) =>
        SetInput(context, NormalizeInput(value));

    private async Task AddTodoAsync(AddTodoContext context)
    {
        if (await TryAddTodoAsync(GetInput(context)))
        {
            SetInput(context, string.Empty);
            if (context == AddTodoContext.Mobile)
            {
                isAddingMobile = false;
            }
        }
    }

    private async Task HandleKeyDownAsync(AddTodoContext context, KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await AddTodoAsync(context);
        }
    }

    private async Task<bool> TryAddTodoAsync(string value)
    {
        var trimmed = value.Trim();
        if (string.IsNullOrWhiteSpace(trimmed))
        {
            return false;
        }

        await TodoState.AddAsync(trimmed, GetCancellationToken());
        return true;
    }

    private Task ToggleTodoAsync(string id)
    {
        return TodoState.ToggleAsync(id, GetCancellationToken());
    }

    private Task DeleteTodoAsync(string id)
    {
        return TodoState.DeleteAsync(id, GetCancellationToken());
    }

    private async Task StartMobileAddAsync()
    {
        isAddingMobile = true;
        SetInput(AddTodoContext.Mobile, string.Empty);

        await Task.Yield();
        if (mobileAddRef != null)
        {
            await mobileAddRef.FocusAsync();
        }
    }

    private void CancelMobileAdd()
    {
        SetInput(AddTodoContext.Mobile, string.Empty);
        isAddingMobile = false;
    }

    public ValueTask DisposeAsync()
    {
        TodoState.StateChanged -= HandleTodoStateChanged;
        if (_cts != null)
        {
            _cts.Cancel();
            _cts.Dispose();
        }

        return ValueTask.CompletedTask;
    }

    private static string NormalizeInput(string value) => value ?? string.Empty;

    private CancellationToken GetCancellationToken() => _cts != null ? _cts.Token : CancellationToken.None;
}
