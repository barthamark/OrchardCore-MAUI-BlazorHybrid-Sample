@page "/"
@attribute [Authorize]
@inject AppState AppState

<PageTitle>Tasks</PageTitle>

<main class="content-container page-padding pb-32 md:pb-6 flex-1">
    <div class="max-w-5xl mx-auto w-full space-y-6">
        <section class="hidden md:block">
            <AddTodoInput IsInline="true"
                          Value="@newTodoText"
                          ValueChanged="HandleDesktopValueChanged"
                          OnSubmit="AddTodoFromDesktop"
                          OnKeyDown="HandleDesktopKeyDown"
                          @ref="desktopAddRef" />
        </section>

        <section class="md:hidden @(isAddingMobile ? string.Empty : "hidden")">
            <AddTodoInput IsInline="false"
                          Value="@newTodoMobileText"
                          ValueChanged="HandleMobileValueChanged"
                          OnSubmit="AddTodoFromMobile"
                          OnCancel="CancelMobileAdd"
                          OnKeyDown="HandleMobileKeyDown"
                          @ref="mobileAddRef" />
        </section>

        <TodoList Items="todoView" Toggle="ToggleTodo" Delete="DeleteTodo" />

        <section class="text-center py-12 @(todoView.Count == 0 ? string.Empty : "hidden")" data-state="empty">
            <div class="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center bg-brand text-white">
                <i class="icon-check text-xl" aria-hidden="true"></i>
            </div>
            <p class="text-[color:var(--color-text-muted)] text-lg">No tasks yet</p>
        </section>
    </div>
</main>

<FloatingActionButton Hidden="isAddingMobile" OnClick="StartMobileAdd" />

@code {
    private readonly List<TodoItem> todos =
    [
        new TodoItem(1, "Design new landing page", false),
        new TodoItem(2, "Update documentation", true),
        new TodoItem(3, "Plan onboarding session", false),
    ];

    private readonly List<TodoList.TodoItemModel> todoView = new();

    private int nextId = 4;
    private string newTodoText = string.Empty;
    private string newTodoMobileText = string.Empty;
    private bool isAddingMobile;

    private AddTodoInput? desktopAddRef;
    private AddTodoInput? mobileAddRef;

    protected override void OnInitialized()
    {
        if (AppState.UserProfile is null)
        {
            AppState.SetUserProfile(new UserProfile
            {
                UserId = Guid.NewGuid().ToString("N"),
                UserName = "John Doe",
                Email = "john@example.com",
            });
        }

        SyncView();
    }

    private void HandleDesktopValueChanged(string? value) => newTodoText = value ?? string.Empty;
    private void HandleMobileValueChanged(string? value) => newTodoMobileText = value ?? string.Empty;

    private void AddTodoFromDesktop()
    {
        if (TryAddTodo(newTodoText))
        {
            newTodoText = string.Empty;
        }
    }

    private void AddTodoFromMobile()
    {
        if (TryAddTodo(newTodoMobileText))
        {
            newTodoMobileText = string.Empty;
            isAddingMobile = false;
        }
    }

    private bool TryAddTodo(string? value)
    {
        var trimmed = value?.Trim();
        if (string.IsNullOrEmpty(trimmed))
        {
            return false;
        }

        todos.Insert(0, new TodoItem(nextId++, trimmed, false));
        SyncView();
        return true;
    }

    private void ToggleTodo(int id)
    {
        var todo = todos.FirstOrDefault(t => t.Id == id);
        if (todo is null)
        {
            return;
        }

        todo.IsCompleted = !todo.IsCompleted;
        SyncView();
    }

    private void DeleteTodo(int id)
    {
        var todo = todos.FirstOrDefault(t => t.Id == id);
        if (todo is null)
        {
            return;
        }

        todos.Remove(todo);
        SyncView();
    }

    private async Task StartMobileAdd()
    {
        isAddingMobile = true;
        newTodoMobileText = string.Empty;

        await Task.Yield();
        if (mobileAddRef is not null)
        {
            await mobileAddRef.FocusAsync();
        }
    }

    private void CancelMobileAdd()
    {
        newTodoMobileText = string.Empty;
        isAddingMobile = false;
    }

    private void HandleDesktopKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            AddTodoFromDesktop();
        }
    }

    private void HandleMobileKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            AddTodoFromMobile();
        }
    }

    private void SyncView()
    {
        todoView.Clear();
        todoView.AddRange(todos.Select(t => new TodoList.TodoItemModel(t.Id, t.Title, t.IsCompleted)));
    }

    private class TodoItem
    {
        public TodoItem(int id, string title, bool isCompleted)
        {
            Id = id;
            Title = title;
            IsCompleted = isCompleted;
        }

        public int Id { get; }
        public string Title { get; }
        public bool IsCompleted { get; set; }
    }
}
