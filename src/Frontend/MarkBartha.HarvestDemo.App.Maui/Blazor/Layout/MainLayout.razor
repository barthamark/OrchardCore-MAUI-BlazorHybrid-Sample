@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager Navigation
@inject ExternalAuthenticationStateProvider AuthStateProvider

<div class="min-h-screen bg-surface-1 flex flex-col relative">
    <Header Title="@headerTitle"
                    OnMenu="OpenMenu" />

    <Sidebar IsOpen="@isSidebarOpen"
               OnClose="CloseMenu"
               OnSignOut="SignOutAsync" />

    <div class="flex-1 flex flex-col">
        @Body
    </div>
</div>

@code {
    private bool isSidebarOpen;
    private string headerTitle = "Tasks";

    protected override void OnInitialized()
    {
        UpdateHeaderTitle(Navigation.Uri);
        Navigation.LocationChanged += HandleLocationChanged;
    }

    private void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    {
        UpdateHeaderTitle(e.Location);
        _ = InvokeAsync(StateHasChanged);
    }

    private void UpdateHeaderTitle(string uri)
    {
        var relative = Navigation.ToBaseRelativePath(uri);

        headerTitle = string.IsNullOrEmpty(relative) || relative.StartsWith("dashboard", StringComparison.OrdinalIgnoreCase)
            ? "Tasks"
            : "Harvest Demo";
    }

    private void OpenMenu()
    {
        if (!isSidebarOpen)
        {
            isSidebarOpen = true;
            StateHasChanged();
        }
    }

    private void CloseMenu()
    {
        if (isSidebarOpen)
        {
            isSidebarOpen = false;
            StateHasChanged();
        }
    }

    private async Task SignOutAsync()
    {
        await AuthStateProvider.LogoutAsync();
        CloseMenu();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }
}
